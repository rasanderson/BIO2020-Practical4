---
title: 'Practical 4: Generalised Linear Models'
author: "Bio2020"
output: word_document
---
# Introduction
Generalised linear models (GLMs) are, as their name suggests, an extension of the standard linear model. They still work to the same framework of a response variable, and one or more explanatory variables. The difference is that they can be much more flexible in the type of response variable you are working with. In a conventional linear model it is assumed that your response variable can take any value, e.g. 4.65, 1.98, -4.32, 65.0, 9241.2 etc. These represent a "normal" distribution or bell-shaped curve; you will also see a normal distribution called a "Gaussian" distribution, after the German mathematician Carl Gauss who first described it. Of course in "real" biological data, some of these values would not make any sense. You might have:

* **Binary data** Presence / Absence, Dead / Alive, Diseased / Healthy, Mutant / Wild Type etc.
* **Count data** Number of birds in different gardens, counts of pollinators visiting flowers, number of muscle reflexes in response to electical stimuli etc.
* **Positive numbers only** Heights of oak trees, weights of brown rats, yield of crops etc. These numbers might have decimal places, but they cannot be negative
* **Proportion or percentages** These are "bounded" numbers, between 0 and 1.0, or 0 and 100 respectively.

If you use a conventional linear model with these types of data, when you check the model assumptions, especially via a QQ plot, you may observe distortions, suggesting the linear model is not valid. You can sometimes transform your data before analysis by a linear model, for example take the `log(number_of_birds + 1)` as a response variable (we include the `+ 1` as it is not possible to take a logarithm of zero). However, it is usually better to use a generalised linear model from the outset.

A linear model works best with normal (Gaussian) data, but a GLM can be extended to a wide range of data types, including all four described above. To remind yourself of the underlying theory of GLMs go to [This Interactive Website](https://naturalandenvironmentalscience.shinyapps.io/generalised_linear_models/) and we will begin by using some of the examples from that website.

The overall aim of this practical is to help you have a better understanding of GLMs, how to set them up in R/RStudio, and learn how to interpret their outputs. Specific objectives of Practical 4 are:

1. Use of GLMs with counts (whole number response data)
2. Use of GLMs with binary responses (presence / absence, dead / alive etc.)
3. Explore these concepts with new datasets
4. Consider lognormal response data (response positive numbers, e.g. weight, height)

## Setting up for the practical  

First, go to Canvas and download the **lichen.csv** and **sppcount.csv** data sets and save them to your **Data** folder in the **BIO2020** folder where you have your R project stored.  

Second, start RStudio, and click on **File -> Recent Projects** and select the BIO2020 project.

Finally, create a new R script by clicking on **File -> New File -> R Script**. Save this file into your BIO2020 folder, calling it _**Practical_4.R**_ **Note** If your PC/MacBook is configured so that the full filenames are not displayed, which is often the default, then simply call your new script **_Practical_4_** when prompted.

## Initial lines in your script

As usual, begin your script with a useful comment, and then load the `bio2020` package. If you have not managed to install it, please load the `mosaic` package.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Practical 4. Exploration of data using generalised linear models

# Load up essential libraries before beginning
library(bio2020)

```

#### Loading Data  

Now load in the two .csv files you downloaded at the very beginning of the practical. If the data is not in a folder called data, you will have to change the file path to match where your data is stored. 
```{r echo=TRUE,  message=FALSE, warning=FALSE}
lichen_dat <- read.csv("Data/lichen.csv")
sppcount_dat <- read.csv("Data/sppcount.csv")

```


# 1. GLMs with counts data
## 1.1 Counts of numbers of aquatic invertebrate species
Aquatic invertebrates provide very useful bioindicators of river systems. A pollution event might be short-lived, and pollutants in the water only detectable for a few days after a spillage. However the effects on the aquatic invertebrates can be detectable for days, weeks or months. They are used by the UK's Environment Agency, Defra, Scottish, Welsh and NI governments to assess aquatic pollution through a system known as RIVPACS [see their website here for more details](https://www.ceh.ac.uk/services/rivpacs-reference-database).

#### Summary Statistics 

It is always good to start by observing the data and running some summary statistics. 

```{r echo=TRUE, include=TRUE}
summary(sppcount_dat)

sd(~species, data = sppcount_dat)

sd(~pollution, data = sppcount_dat)

#Visualise

gf_point(pollution~species, data = sppcount_dat) %>% 
  gf_lm() %>% 
  gf_theme(theme_minimal())

```

The plot above shows a clear link between species abundance and the amount of pollution present but visualising it is not enough we need to back up our hypothesis with statistical analysis.  

It is also a good habit to examine the data structurally as well as statistically to see how variables are laid out and what format they are in. The `summary()` command outlines the data into very basic statistics such as **mean**, **median**, **1st and 3rd quartiles** and **min and max**. The `str()` command displays what type of variables there (ie numeric, character or factor) and how they are stored (ie vector or data frame). In the following example the data is in two different categories **num** which is the class used for nonwhole nubmers and **int** which is teh class used for interger or whole numbers.  
```{r echo=TRUE, include=TRUE}
str(sppcount_dat)

```

#### GLMs

As your response data (species) are count variables, where no fractional values are possible, we will use a "Poisson"" error model in this GLM.  

```{r echo=TRUE, include=TRUE}
spp_glm <- glm(species ~ pollution, data = sppcount_dat, family = poisson)
summary(spp_glm)

```

So now what does this all mean. 

- The **deviance residuals** are the deviance of each data point. The model calculates the deviation of the data point and the value left is your residuals.
- The **coefficients** are your **covariate** variables (ie pollution). You may notice that there are two coefficients when our model only specified one. The intercept is the predicted values when your independent variable (species) is zero. The **estimate** is the estimated log value in the change of your response variable (pollution) if your covariate (pollution) were one unit higher. The estimate for the intercept is the estimate log value of species if pollution were 0. The **std error** is the variation around the mean, and the **z value** is the `estimate/std error`. Lastly, the **p value** is the measure of significance. The lower the p value, the more significant the result. The `***` proceeding the p value is a visual indicator of significance, and the key for those significant codes is just below the coefficients.
- The **residual deviance** is a measure of how good your model is. If your residual deviance value is close to zero, then the model is oversaturated and not very good. 
- The **AIC** value is used when comparing two similar models, the lower the AIC, the better the model.
- Finally, the **Fisher score** is a measure of how many iterations of the model R ran looking at different estimates before displaying the results. 

From the results of the GLM, we can see that our original theory gathered from the plot was correct. There is a distinct significant relationship between species count and the amount of pollution present in a system. the fact that the **p value** is <0.001 means that the relationship is highly significant. The fact that both the **z value** and **estimate** are negative tells us that the relationship between the response variable and covariate is a negative one or in this case that as pollution levels rise species count will fall. 

## GLMs with Binary Lichen Data

Your experiment may produce categorical response data, e.g. male or female, wilted or turgid, infected or uninfected, dead or alive. Note that a response such as simply 'dead' or 'alive' differs from a response where you have counts of the numbers of dead or alive out of your original sample, which are analysed as proportion data in the previous example. Here there is in effect less information available for you as an experimenter, and so you have to handle slightly coarser, categorical information.

The method used by R to handle such a response is to treat the categories as 0 or 1, and assume they are still from a binomial sample, but with a sample size of only 1.
In this example, you are testing the effect of atmospheric pollution on the presence or absence of lichen's growth on trees. Lichens have been found to be very sensitive biological indicators of atmospheric pollution. As lichen growth can be affected by the tree bark, particularly calcium content, this was also measured. Your response is a 1 or 0, where 1 indicates lichen are present and 0 lichen absent. 

#### Summary Statistics

Start with some visualisation and summary statistics. What do the plots bellow tell you about lichen ecology? Can you form some initial assumptions based on what they show?  








```{r echo=TRUE, include=TRUE}
summary(lichen_dat)
str(lichen_dat)

sd(~airpoll, data = lichen_dat)

sd(~airpoll, data = lichen_dat)

#Visualise
gf_violin(calcium~as.factor(lichen), data = lichen_dat, alpha = 0.3, fill = ~as.character(lichen)) %>% 
  gf_sina(calcium~as.factor(lichen)) %>% 
  gf_labs(x = "Lichen", y = "Calcium", title = "Lichen and Calcium") %>% 
  gf_theme(theme_minimal()) %>% 
  gf_theme(legend.title = element_blank())

gf_violin(airpoll~as.factor(lichen), data = lichen_dat, alpha = 0.3, fill = ~as.character(lichen)) %>% 
  gf_sina(airpoll~as.factor(lichen)) %>% 
  gf_labs(x = "Lichen", y = "Air Pollution", title = "Lichen and Pollution") %>% 
  gf_theme(theme_minimal()) %>% 
  gf_theme(legend.title = element_blank())

```

#### GLMs

When a GLM contains a `:` in the covariates such as this `glm(response ~ covariate1 + covariate2 + covariate1:covariate2, data = data, family = family)` it means that the model will test to see if an interaction between the two variables is having a significant effect. If the data you are modelling contains more the just two possible covariates, you can use a `*` to test for all possible interactions such as this `glm(response ~ covariate1*covariate2*covariate3, data = data, family = family)`. This results in all covariate being examined individually but also as groups such as this (notice the three way interaction):

|   -covariate1 results  
|   -covariate2 results   
|   -covariate3 results  
|   -covariate1:covariate2 results  
|   -covariate1:covariate3 results  
|   -covariate2:covariate3 results  
|   -covariate1:covariate2:covariate3 results  

We will begin by running a full model including, the interaction terms; however, these can be removed later if not necessary. Notice that the family for this model has been changed as we now have a binary response variable. 

```{r echo=TRUE, include=TRUE}

lichen_glm1 <- glm(lichen ~ airpoll + calcium + airpoll:calcium, data = lichen_dat, family = binomial)
summary(lichen_glm1)

```

If the model is **over-fitted or saturated**, it would not be a valid model as it would fit the data perfectly. You can easily see if this is the case by looking at the summary. If there are zero residual degrees of freedom, and the residual deviance is also zero (on your PC the zero may be expressed in exponential format due to rounding), then the model is oversaturated and not a good fit. The model is not overdispersed, but none of the predictors are significant. Next fit a simpler model, with only main effects and without the interaction term, and compare the two. 

```{r echo=TRUE, include=TRUE}
lichen_glm2 <- glm(lichen ~ airpoll + calcium, data = lichen_dat, family = binomial)
summary(lichen_glm2)

```

Notice now that the main covariates are significant after removing the interaction term. Also, the **AIC** value is lower in the second model meaning this model is an improvement over the more complex one we ran earlier. What do the results of this simpler model tell you about lichen and its relationship with calcium and air pollution?